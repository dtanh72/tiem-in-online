{% extends 'UI/base.html' %}

{% block title %}QU·∫¢N L√ù TRANG THI·∫æT B·ªä{% endblock %}

{% block content %}

    <h1>{{ equipment_info.equipment_name }}</h1>
    <a href="{{ url_for('equipment_page') }}" class="btn btn-sm btn-warning">&larr; Quay l·∫°i Danh s√°ch Thi·∫øt b·ªã</a>

    <div class="mb-3">
        <div class="equipment-info">
			<div class="d-flex justify-content-between align-items-start">
				<h2>Th√¥ng tin Thi·∫øt b·ªã</h2>
				<button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editInfoModal">
					‚úèÔ∏è S·ª≠a th√¥ng tin
				</button>
			</div>
			
			<div class="row">
				<div class="col-md-6">
					<p><strong>Model:</strong> {{ equipment_info.model_number }}</p>
					<p><strong>IP:</strong> {{ equipment_info.ip_address or 'Ch∆∞a c√≥' }}</p>
					<p><strong>Serial:</strong> {{ equipment_info.serial_number or 'Ch∆∞a c√≥' }}</p>
				</div>
				<div class="col-md-6">
					<p><strong>Ng√†y mua:</strong> {{ equipment_info.purchase_date }}</p>
					<p><strong>Tr·∫°ng th√°i:</strong> {{ equipment_info.status }}</p>
					<p><strong>NCC:</strong> {{ equipment_info.supplier_name or 'N/A' }}</p>
				</div>
			</div>

			<p class="fs-4 text-primary mt-2">
				<strong>B·ªô ƒë·∫øm:</strong> {{ equipment_info.print_count|currency }} b·∫£n in
			</p>
		</div>

        <div class="log-form">
            <h2>Th√™m Nh·∫≠t k√Ω B·∫£o tr√¨ M·ªõi</h2>
            <form action="{{ url_for('add_maintenance_log') }}" method="POST" class="card card-body bg-light mb-4">
                
                <input type="hidden" name="equipment_id" value="{{ equipment_info.equipment_id }}">
                <div class="mb-3">
					<label for="current_machine_counter" class="form-label text-primary fw-bold">Counter hi·ªán t·∫°i c·ªßa m√°y:</label>
					<input type="number" id="current_machine_counter" name="current_machine_counter" 
						   class="form-control" required 
						   value="{{ equipment_info.print_count }}"> 
						   <small class="text-muted">Nh·∫≠p s·ªë counter th·ª±c t·∫ø tr√™n ƒë·ªìng h·ªì m√°y l√∫c b·∫£o tr√¨.</small>
				</div>
				
                <div class="mb-3">
                    <label for="maintenance_date" class="form-label">Ng√†y b·∫£o tr√¨:</label><br>
                    <input type="date" id="maintenance_date" class="form-control" name="maintenance_date" required>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">M√¥ t·∫£ c√¥ng vi·ªác:</label><br>
                    <textarea id="description" class="form-control" name="description" rows="3" required placeholder="V√≠ d·ª•: Thay tr·ªëng (drum) m√†u ƒëen"></textarea>
                </div>
                <div class="mb-3">
                    <label for="cost" class="form-label">Chi ph√≠ (vnƒë):</label><br>
                    <input type="number" id="cost" class="form-control" name="cost" value="0">
                </div>
				
				<div class="mb-3 mt-2">
					<label class="form-label">Tr·∫°ng th√°i thanh to√°n:</label>
					<div class="form-check">
						<input class="form-check-input" type="radio" name="payment_status" id="pay_unpaid" value="unpaid" checked>
						<label class="form-check-label" for="pay_unpaid">
							Ch∆∞a tr·∫£ (Ghi c√¥ng n·ª£ NCC)
						</label>
					</div>
					<div class="form-check">
						<input class="form-check-input" type="radio" name="payment_status" id="pay_paid" value="paid">
						<label class="form-check-label text-success" for="pay_paid">
							ƒê√£ thanh to√°n ngay
						</label>
					</div>
				</div>
				
				<div>
					<label for="supplier_id" class="form-label">Nh√† cung c·∫•p (B·∫£o tr√¨):</label>
					<div class="input-group mb-3">
						<select id="supplier_id" name="supplier_id" class="form-select">
							<option value="">-- T·ª± l√†m / Kh√¥ng x√°c ƒë·ªãnh --</option>
							{% for supplier in suppliers_list %}
								<option value="{{ supplier.supplier_id }}">{{ supplier.supplier_name }}</option>
							{% endfor %}
						</select>
						<button class="btn btn-outline-success" type="button" 
								data-bs-toggle="modal" data-bs-target="#quickAddSupplierModal">+</button>
					</div>
				</div>
                <div class="mb-3">
                    <label for="technician_name" class="form-label">K·ªπ thu·∫≠t vi√™n:</label><br>
                    <input type="text" id="technician_name" class="form-control" name="technician_name" placeholder="V√≠ d·ª•: Anh T√≠n (Konica)">
                </div>
				<hr>
				<p><strong>Th√¥ng Tin Linh Ki·ªán Thay Th·∫ø</strong></p>
				<div class="mb-3">
					<label for="replaced_material_id" class="form-label">Linh ki·ªán ƒë√£ thay:</label>
					<select id="replaced_material_id" name="replaced_material_id" class="form-select">
						<option value="">-- Kh√¥ng thay linh ki·ªán --</option>
						{% for part in maintenance_parts_list %}
							<option value="{{ part.material_id }}">
								{{ part.material_name }} (T·ªìn kho: {{ part.stock_quantity }})
							</option>
						{% endfor %}
					</select>
				</div>
				<div class="mb-3">
					<label for="replaced_quantity" class="form-label">S·ªë l∆∞·ª£ng thay:</label>
					<input type="number" id="replaced_quantity" name="replaced_quantity" class="form-control" value="0">
				</div>
				<div class="row">
					<div class="col-md-6 mb-3">
						<label for="warranty_end_date" class="form-label">B·∫£o h√†nh ƒë·∫øn ng√†y:</label>
						<input type="date" id="warranty_end_date" name="warranty_end_date" class="form-control">
					</div>
					<div class="col-md-6 mb-3">
						<label for="warranty_end_counter" class="form-label">HO·∫∂C ƒë·∫øn s·ªë Counter:</label>
						<input type="number" id="warranty_end_counter" name="warranty_end_counter" class="form-control" placeholder="VD: 120000">
					</div>
				</div>
				<small class="text-muted d-block mb-3">Nh·∫≠p th√¥ng tin b·∫£o h√†nh n·∫øu c√≥ (Ng√†y ho·∫∑c S·ªë b·∫£n in).</small>
                <button type="submit" 
                        style="padding: 10px; background: #007bff; color: white; border: none;"
                        onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th√™m nh·∫≠t k√Ω b·∫£o tr√¨ n√†y?');"
						class="btn btn-primary">
                    L∆∞u Nh·∫≠t k√Ω
                </button>
            </form>
        </div>
    </div>

    <h2 style="margin-top: 20px;">L·ªãch s·ª≠ B·∫£o tr√¨ c·ªßa M√°y n√†y</h2>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Ng√†y b·∫£o tr√¨</th>
				<th>Counter l√∫c thay</th>
                <th>M√¥ t·∫£</th>
                <th>Chi ph√≠ (vnƒë)</th>
				<th>Nh√† cung c·∫•p (B·∫£o tr√¨)</th>
                <th>K·ªπ thu·∫≠t vi√™n</th>
				<th>B·∫£o h√†nh (H·∫°n)</th>
				<th>TT Thanh to√°n</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs_list %}
            <tr>
                <td>{{ log.maintenance_date }}</td>
				<td class="fw-bold">{{ log.current_counter_at_log|currency }}</td>
                <td>
					{{ log.description }}
					{% if log.replaced_part_name %}
						<br><small class="text-muted">Thay: {{ log.replaced_part_name }} (SL: {{ log.replaced_quantity }})</small>
					{% endif %}
				</td>
                <td>{{ log.cost|currency }}</td>
				<td>{{ log.supplier_name or 'T·ª± l√†m' }}</td>
                <td>{{ log.technician_name }}</td>				
				<td class="small">
					{% if log.warranty_end_date %}
						<div>üìÖ {{ log.warranty_end_date }}</div>
					{% endif %}
					{% if log.warranty_end_counter %}
						<div>üî¢ {{ log.warranty_end_counter|currency }}</div>
					{% endif %}
					{% if not log.warranty_end_date and not log.warranty_end_counter %}
						-
					{% endif %}
				</td>
				<td style="color: {% if log.payment_status == 'unpaid' and log.cost > 0 %}red{% else %}green{% endif %};">
					{{ log.payment_status }}
				</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
	
	<div class="modal fade" id="quickAddSupplierModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Th√™m Nh√† cung c·∫•p M·ªõi</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="quickAddSupplierForm">
						<div class="mb-3">
							<label class="form-label">T√™n Nh√† cung c·∫•p:</label>
							<input type="text" id="quick_supplier_name" class="form-control" required>
						</div>
						<div class="mb-3">
							<label class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label>
							<input type="text" id="quick_supplier_phone" class="form-control">
						</div>
						<div class="mb-3">
							<label class="form-label">Email:</label>
							<input type="email" id="quick_supplier_email" class="form-control">
						</div>
						<div id="quickSupplierError" class="text-danger"></div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" id="saveQuickSupplier" class="btn btn-primary">L∆∞u NCC</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="editInfoModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">S·ª≠a Th√¥ng tin Thi·∫øt b·ªã</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form action="{{ url_for('edit_equipment_info') }}" method="POST">
						<input type="hidden" name="equipment_id" value="{{ equipment_info.equipment_id }}">
						
						<div class="mb-3">
							<label class="form-label">T√™n Thi·∫øt b·ªã:</label>
							<input type="text" name="equipment_name" class="form-control" value="{{ equipment_info.equipment_name }}" required>
						</div>
						
						<div class="row mb-3">
							<div class="col-6">
								<label class="form-label">ƒê·ªãa ch·ªâ IP:</label>
								<input type="text" name="ip_address" class="form-control" value="{{ equipment_info.ip_address or '' }}">
							</div>
							<div class="col-6">
								<label class="form-label">S·ªë Serial:</label>
								<input type="text" name="serial_number" class="form-control" value="{{ equipment_info.serial_number or '' }}">
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label">Model:</label>
							<input type="text" name="model_number" class="form-control" value="{{ equipment_info.model_number }}">
						</div>

						<div class="mb-3">
							<label class="form-label">Nh√† cung c·∫•p:</label>
							<select name="supplier_id" class="form-select">
								<option value="">-- Kh√¥ng x√°c ƒë·ªãnh --</option>
								{% for supplier in suppliers_list %}
									<option value="{{ supplier.supplier_id }}" {% if supplier.supplier_id == equipment_info.supplier_id %}selected{% endif %}>
										{{ supplier.supplier_name }}
									</option>
								{% endfor %}
							</select>
						</div>

						<div class="row mb-3">
							<div class="col-6">
								<label class="form-label">Ng√†y mua:</label>
								<input type="date" name="purchase_date" class="form-control" value="{{ equipment_info.purchase_date }}">
							</div>
							<div class="col-6">
								<label class="form-label">H·∫°n b·∫£o h√†nh (Ng√†y):</label>
								<input type="date" name="warranty_end_date" class="form-control" value="{{ equipment_info.warranty_end_date }}">
							</div>
						</div>

						<div class="text-end">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
							<button type="submit" class="btn btn-primary">L∆∞u Thay ƒë·ªïi</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const saveBtn = document.getElementById('saveQuickSupplier');
			
			if(saveBtn){
				saveBtn.addEventListener('click', function() {
					const name = document.getElementById('quick_supplier_name').value;
					const phone = document.getElementById('quick_supplier_phone').value;
					const email = document.getElementById('quick_supplier_email').value;
					
					if(!name) {
						document.getElementById('quickSupplierError').textContent = "Vui l√≤ng nh·∫≠p t√™n NCC";
						return;
					}

					const formData = new FormData();
					formData.append('supplier_name', name);
					formData.append('phone', phone);
					formData.append('email', email);

					fetch("{{ url_for('ajax_add_supplier') }}", {
						method: 'POST',
						body: formData
					})
					.then(response => response.json())
					.then(data => {
						if(data.success) {
							// Th√™m v√†o dropdown
							const select = document.getElementById('supplier_id');
							const option = document.createElement('option');
							option.value = data.new_id;
							option.text = data.new_name;
							option.selected = true;
							select.appendChild(option);
							
							// ƒê√≥ng modal
							bootstrap.Modal.getInstance(document.getElementById('quickAddSupplierModal')).hide();
							document.getElementById('quickAddSupplierForm').reset();
						} else {
							alert('L·ªói: ' + data.error);
						}
					});
				});
			}
		});
	</script>

{% endblock %}