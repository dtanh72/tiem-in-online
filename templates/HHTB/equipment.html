{% extends 'UI/base.html' %}

{% block title %}QU·∫¢N L√ù TRANG THI·∫æT B·ªä{% endblock %}

{% block content %}

    <h1>Trang Qu·∫£n l√Ω Thi·∫øt b·ªã</h1>

    <h2>Th√™m Thi·∫øt b·ªã M·ªõi (M√°y in, M√°y c·∫Øt...)</h2>
    <form action="/add_equipment" method="POST" class="card card-body bg-light mb-4">
        <div class="mb-3">
            <label for="equipment_name" class="form-label">T√™n Thi·∫øt b·ªã:</label><br>
            <input type="text" id="equipment_name" class="form-control" name="equipment_name" required placeholder="V√≠ d·ª•: M√°y in m√†u Konica C6085">
        </div>
		
		<div class="row mt-2">
            <div class="col-md-6">
                <label for="ip_address" class="form-label">ƒê·ªãa ch·ªâ IP:</label>
                <input type="text" id="ip_address" name="ip_address" class="form-control" placeholder="192.168.1.200">
            </div>
            <div class="col-md-6">
                <label for="serial_number" class="form-label">S·ªë Serial (S/N):</label>
                <input type="text" id="serial_number" name="serial_number" class="form-control" placeholder="S/N c·ªßa m√°y">
            </div>
        </div>
		
        <div class="mb-3">
            <label for="model_number" class="form-label">Model:</label><br>
            <input type="text" id="model_number" class="form-control" name="model_number" placeholder="V√≠ d·ª•: C6085">
        </div>
		<div class="mb-3">
			<label for="supplier_id" class="form-label">Nh√† cung c·∫•p (N∆°i mua):</label>
			<div class="input-group">
				<select id="supplier_id" name="supplier_id" class="form-select">
					<option value="">-- Kh√¥ng x√°c ƒë·ªãnh --</option>
					{% for supplier in suppliers_list %}
						<option value="{{ supplier.supplier_id }}">{{ supplier.supplier_name }}</option>
					{% endfor %}
				</select>
				<button class="btn btn-outline-success" type="button" 
						data-bs-toggle="modal" data-bs-target="#quickAddSupplierModal">+</button>
			</div>
		</div>
        <div class="mb-3">
            <label for="purchase_date" class="form-label">Ng√†y mua:</label><br>
            <input type="date" id="purchase_date" name="purchase_date" class="form-control">
        </div>
		
		<div class="col-md-6">
                <label for="initial_counter" class="form-label text-primary fw-bold">Counter ban ƒë·∫ßu:</label>
                <input type="number" id="initial_counter" name="initial_counter" class="form-control" value="0">
                <small class="text-muted">S·ªë b·∫£n in ƒë√£ ch·∫°y khi nh·∫≠n m√°y.</small>
            </div>
        
		<div class="row">
            <div class="col-md-6 mb-3">
                <label for="warranty_end_date" class="form-label">B·∫£o h√†nh ƒë·∫øn ng√†y:</label>
                <input type="date" id="warranty_end_date" name="warranty_end_date" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label for="warranty_end_counter" class="form-label">HO·∫∂C ƒë·∫øn s·ªë Counter:</label>
                <input type="number" id="warranty_end_counter" name="warranty_end_counter" class="form-control" placeholder="VD: 500000">
            </div>
        </div>
        <small class="text-muted d-block mb-3">Th√¥ng tin b·∫£o h√†nh m√°y (n·∫øu c√≥).</small>
		
		<button type="submit" class="btn btn-primary">L∆∞u Thi·∫øt b·ªã</button>
    </form>

    <h2>Danh s√°ch Thi·∫øt b·ªã</h2>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>T√™n Thi·∫øt b·ªã</th>
                <th>Model</th>
				<th>Nh√† cung c·∫•p</th>
                <th>B·∫£o h√†nh (H·∫°n)</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            {% for eq in equipment_list %}
            <tr class="{% if not eq.is_active %}table-secondary text-muted{% endif %}">
                <td>{{ eq.equipment_id }}</td>                
				<td class="fw-bold">
                    {{ eq.equipment_name }}
                    {% if not eq.is_active %}(ƒê√£ kh√≥a)
					{% else %}
						<br><small class="text-muted">IP: {{ eq.ip_address or 'Ch∆∞a c√≥' }}</small>
						<br><small class="text-muted">SN: {{ eq.serial_number or 'Ch∆∞a c√≥' }}</small>
						<br><small class="text-muted">Ng√†y mua: {{ eq.purchase_date }}</small>
					{% endif %}
                </td>
                <td>{{ eq.model_number }}</td>
				<td>{{ eq.supplier_name or 'N/A' }}</td>
                <td class="small">
                    {% if eq.warranty_end_date %}
                        <div>üìÖ {{ eq.warranty_end_date }}</div>
                    {% endif %}
                    {% if eq.warranty_end_counter %}
                        <div>üî¢ {{ eq.warranty_end_counter|currency }}</div>
                    {% endif %}
                    {% if not eq.warranty_end_date and not eq.warranty_end_counter %}
                        -
                    {% endif %}
                </td>
                <td>{{ eq.status }}</td>
                
				<td>
                    {% if eq.is_active %}
                        <a href="{{ url_for('equipment_detail_page', equipment_id=eq.equipment_id) }}" class="btn btn-sm btn-warning">S·ª≠a / Xem Nh·∫≠t k√Ω</a>
                    {% endif %}

                    <form action="{{ url_for('toggle_equipment', id=eq.equipment_id) }}" method="POST" style="display:inline;">
                        {% if eq.is_active %}
                            <button type="submit" class="btn btn-sm btn-danger" 
                                    onclick="return confirm('Kh√≥a thi·∫øt b·ªã n√†y? N√≥ s·∫Ω ·∫©n kh·ªèi c√°c trang kh√°c.');">
                                üîí Kh√≥a
                            </button>
                        {% else %}
                            <button type="submit" class="btn btn-sm btn-success">
                                üîì M·ªü l·∫°i
                            </button>
                        {% endif %}
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
	
	<div class="modal fade" id="quickAddSupplierModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Th√™m Nh√† cung c·∫•p M·ªõi</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="quickAddSupplierForm">
						<div class="mb-3">
							<label class="form-label">T√™n Nh√† cung c·∫•p:</label>
							<input type="text" id="quick_supplier_name" class="form-control" required>
						</div>
						<div class="mb-3">
							<label class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label>
							<input type="text" id="quick_supplier_phone" class="form-control">
						</div>
						<div class="mb-3">
							<label class="form-label">Email:</label>
							<input type="email" id="quick_supplier_email" class="form-control">
						</div>
						<div id="quickSupplierError" class="text-danger"></div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
					<button type="button" id="saveQuickSupplier" class="btn btn-primary">L∆∞u NCC</button>
				</div>
			</div>
		</div>
	</div>
	
	{% block scripts %}
		<script>
			document.addEventListener('DOMContentLoaded', function() {
				const saveBtn = document.getElementById('saveQuickSupplier');
				
				if(saveBtn){
					saveBtn.addEventListener('click', function() {
						// 1. L·∫•y d·ªØ li·ªáu
						const name = document.getElementById('quick_supplier_name').value;
						const phone = document.getElementById('quick_supplier_phone').value;
						const email = document.getElementById('quick_supplier_email').value;
						
						if(!name) {
							document.getElementById('quickSupplierError').textContent = "Vui l√≤ng nh·∫≠p t√™n NCC";
							return;
						}

						const formData = new FormData();
						formData.append('supplier_name', name);
						formData.append('phone', phone);
						formData.append('email', email);

						// 2. G·ª≠i AJAX (D√πng l·∫°i route c≈© trong app.py)
						fetch("{{ url_for('ajax_add_supplier') }}", {
							method: 'POST',
							body: formData
						})
						.then(response => response.json())
						.then(data => {
							if(data.success) {
								// 3. Th√†nh c√¥ng: Th√™m v√†o dropdown v√† ch·ªçn n√≥
								const select = document.getElementById('supplier_id');
								const option = document.createElement('option');
								option.value = data.new_id;
								option.text = data.new_name;
								option.selected = true;
								select.appendChild(option);
								
								// 4. ƒê√≥ng modal
								// (ƒê·∫£m b·∫£o b·∫°n d√πng ƒë√∫ng c√∫ ph√°p Bootstrap 5)
								const modalEl = document.getElementById('quickAddSupplierModal');
								const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
								modalInstance.hide();
								
								document.getElementById('quickAddSupplierForm').reset();
							} else {
								alert('L·ªói: ' + data.error);
							}
						})
						.catch(err => {
							console.error(err);
							alert('L·ªói k·∫øt n·ªëi server');
						});
					});
				}
			});
		</script>
	{% endblock %}

{% endblock %}