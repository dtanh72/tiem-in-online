{% extends 'UI/base.html' %}
{% block title %}üìã T·∫°o Phi·∫øu Nh·∫≠p Kho{% endblock %}

{% block content %}
    <h1>üìã T·∫°o Phi·∫øu Nh·∫≠p Kho</h1>

    <form action="{{ url_for('submit_import_slip') }}" method="POST">
        <div class="container">
            <div class="row mb-4 bg-light p-3 rounded shadow-sm">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Nh√† cung c·∫•p:</label>
                    <div class="input-group">
                        <select id="supplier_id" name="supplier_id" required class="form-select">
                            <option value="">-- Ch·ªçn Nh√† cung c·∫•p --</option>
                            {% for s in suppliers_list %}
                                <option value="{{ s.supplier_id }}">{{ s.supplier_name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-success" type="button" data-bs-toggle="modal" data-bs-target="#quickAddSupplierModal" title="Th√™m NCC m·ªõi">+</button>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Ng√†y nh·∫≠p:</label>
                    <input type="date" name="import_date" required class="form-control" value="{{ today }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Thanh to√°n:</label>
                    <select name="payment_status" class="form-select">
                        <option value="unpaid">Ch∆∞a tr·∫£ (Ghi n·ª£)</option>
                        <option value="paid">ƒê√£ tr·∫£ ngay</option>
                    </select>
                </div>
                <div class="col-md-2 text-end">
                    <label class="form-label d-block">&nbsp;</label>
                    <div class="fs-4 fw-bold text-danger" id="grand_total">0</div>
                    <small>vnƒë</small>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3>Chi ti·∫øt V·∫≠t t∆∞</h3>
                <button type="button" id="add_row_btn" class="btn btn-primary">+ Th√™m d√≤ng</button>
            </div>
            
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 35%;">V·∫≠t t∆∞</th>
                        <th style="width: 10%;">ƒê∆°n v·ªã</th>
                        <th style="width: 15%;">S·ªë l∆∞·ª£ng</th>
                        <th style="width: 20%;">Gi√° nh·∫≠p (vnƒë)</th>
                        <th style="width: 15%;">Th√†nh ti·ªÅn</th>
                        <th style="width: 5%;">X√≥a</th>
                    </tr>
                </thead>
                <tbody id="import_items_body">
                    </tbody>
            </table>

            <div class="text-end mt-3">
                <button type="submit" class="btn btn-success btn-lg">L∆ØU PHI·∫æU NH·∫¨P</button>
            </div>
        </div>
    </form>

    <table style="display: none;">
        <tr id="row_template">
            <td>
                <div class="input-group">
                    <select name="material_id[]" class="form-select material-select" required onchange="updateUnitDisplay(this)">
                        <option value="" data-unit="">-- Ch·ªçn v·∫≠t t∆∞ --</option>
                        {% for m in materials_list %}
                            <option value="{{ m.material_id }}" data-unit="{{ m.import_unit }}">
                                {{ m.material_name }}
                            </option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-outline-success" type="button" onclick="openQuickAddMaterialModal(this)" title="Th√™m V·∫≠t t∆∞ m·ªõi">+</button>
                </div>
            </td>
            <td>
                <input type="text" class="form-control unit-display text-center" readonly style="background: #eee;">
            </td>
            <td>
                <input type="number" name="quantity[]" class="form-control qty-input" value="1" min="1" oninput="calcTotal()">
            </td>
            <td>
                <input type="number" name="unit_price[]" class="form-control price-input" value="0" oninput="calcTotal()">
            </td>
            <td>
                <input type="text" class="form-control line-total text-end" readonly style="font-weight: bold;">
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(this)">X</button>
            </td>
        </tr>
    </table>

    <div class="modal fade" id="quickAddSupplierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Th√™m Nh√† cung c·∫•p M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quickAddSupplierForm">
                        <div class="mb-3">
                            <label class="form-label">T√™n Nh√† cung c·∫•p:</label>
                            <input type="text" id="quick_supplier_name" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveQuickSupplier" class="btn btn-primary">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="quickAddMaterialModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Th√™m nhanh V·∫≠t t∆∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quickAddMaterialForm">
                        <div class="mb-3">
                            <label class="form-label">T√™n V·∫≠t t∆∞:</label>
                            <input type="text" id="quick_material_name" class="form-control" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">ƒê∆°n v·ªã C∆° s·ªü (Kho):</label>
                                <input type="text" id="quick_base_unit" class="form-control" placeholder="t·ªù" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">ƒê∆°n v·ªã Nh·∫≠p (Mua):</label>
                                <input type="text" id="quick_import_unit" class="form-control" placeholder="ram" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">H·ªá s·ªë (1 ƒêV Nh·∫≠p = ? ƒêV C∆° s·ªü):</label>
                            <input type="number" id="quick_conversion_factor" class="form-control" value="1" step="0.01" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="saveQuickAddMaterial" class="btn btn-primary">L∆∞u V·∫≠t t∆∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. H√ÄM T√çNH TO√ÅN (QUAN TR·ªåNG)
        function calcTotal() {
            let grandTotal = 0;
            const rows = document.querySelectorAll('#import_items_body tr');
            
            rows.forEach(row => {
                const qtyInput = row.querySelector('.qty-input');
                const priceInput = row.querySelector('.price-input');
                
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                
                const total = qty * price;
                
                // Hi·ªÉn th·ªã th√†nh ti·ªÅn d√≤ng (c√≥ d·∫•u ph·∫©y)
                row.querySelector('.line-total').value = total.toLocaleString('vi-VN');
                
                grandTotal += total;
            });
            
            // Hi·ªÉn th·ªã T·ªïng c·ªông (c√≥ d·∫•u ph·∫©y)
            document.getElementById('grand_total').innerText = grandTotal.toLocaleString('vi-VN');
        }

        // 2. H√†m th√™m d√≤ng
        document.getElementById('add_row_btn').addEventListener('click', function() {
            const template = document.getElementById('row_template');
            const newRow = template.cloneNode(true);
            newRow.removeAttribute('id');
            document.getElementById('import_items_body').appendChild(newRow);
            calcTotal(); // T√≠nh l·∫°i (d√π l√† 0)
        });

        // 3. H√†m x√≥a d√≤ng
        window.deleteRow = function(btn) {
            btn.closest('tr').remove();
            calcTotal(); // T√≠nh l·∫°i sau khi x√≥a
        }

        // 4. H√†m hi·ªÉn th·ªã ƒë∆°n v·ªã
        window.updateUnitDisplay = function(select) {
            const unit = select.options[select.selectedIndex].getAttribute('data-unit');
            const row = select.closest('tr');
            row.querySelector('.unit-display').value = unit || '...';
        }

        // 5. Script Th√™m nhanh NCC (AJAX)
        document.getElementById('saveQuickSupplier').addEventListener('click', function() {
            const name = document.getElementById('quick_supplier_name').value;
            if(!name) return;
            const formData = new FormData();
            formData.append('supplier_name', name);
            formData.append('phone', ''); 
            formData.append('email', ''); 

            fetch("{{ url_for('ajax_add_supplier') }}", {
                method: 'POST', body: formData
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    const select = document.getElementById('supplier_id');
                    const opt = document.createElement('option');
                    opt.value = data.new_id; opt.text = data.new_name; opt.selected = true;
                    select.appendChild(opt);
                    bootstrap.Modal.getInstance(document.getElementById('quickAddSupplierModal')).hide();
                } else { alert(data.error); }
            });
        });

        // 6. Script Th√™m nhanh V·∫≠t t∆∞ (AJAX)
        let activeSelectElement = null;
        window.openQuickAddMaterialModal = function(btn) {
            activeSelectElement = btn.previousElementSibling;
            new bootstrap.Modal(document.getElementById('quickAddMaterialModal')).show();
        }

        document.getElementById('saveQuickAddMaterial').addEventListener('click', function() {
            const name = document.getElementById('quick_material_name').value;
            const baseUnit = document.getElementById('quick_base_unit').value;
            const importUnit = document.getElementById('quick_import_unit').value;
            const factor = document.getElementById('quick_conversion_factor').value;

            if(!name) return;
            const formData = new FormData();
            formData.append('material_name', name);
            formData.append('base_unit', baseUnit);
            formData.append('import_unit', importUnit);
            formData.append('import_conversion_factor', factor);

            fetch("{{ url_for('ajax_add_material') }}", {
                method: 'POST', body: formData
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    const newOption = document.createElement('option');
                    newOption.value = data.new_id; newOption.text = data.new_name;
                    newOption.setAttribute('data-unit', data.new_import_unit);

                    const allSelects = document.querySelectorAll('.material-select');
                    allSelects.forEach(select => { select.appendChild(newOption.cloneNode(true)); });

                    if (activeSelectElement) {
                        activeSelectElement.value = data.new_id;
                        updateUnitDisplay(activeSelectElement);
                    }
                    bootstrap.Modal.getInstance(document.getElementById('quickAddMaterialModal')).hide();
                    document.getElementById('quickAddMaterialForm').reset();
                } else { alert(data.error); }
            });
        });

        // Th√™m 1 d√≤ng m·∫∑c ƒë·ªãnh khi t·∫£i trang
        document.getElementById('add_row_btn').click();
    </script>
{% endblock %}