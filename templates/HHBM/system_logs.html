{% extends 'UI/base.html' %}
{% block title %}Nh·∫≠t k√Ω H·ªá th·ªëng{% endblock %}

{% block content %}
    <h1>Nh·∫≠t k√Ω Ho·∫°t ƒë·ªông (Audit Logs)</h1>

    <div class="card card-body bg-light mb-3">
        <form method="GET" action="{{ url_for('system_logs_page') }}" class="row g-3 align-items-end">
            <div class="col-md-3">
				<label class="form-label fw-bold">T·ª´ ng√†y:</label>
				<input type="date" id="filter_start" name="start_date" class="form-control" value="{{ start_date or '' }}">
			</div>
			<div class="col-md-3">
				<label class="form-label fw-bold">ƒê·∫øn ng√†y:</label>
				<input type="date" id="filter_end" name="end_date" class="form-control" value="{{ end_date or '' }}">
			</div>
            <div class="col-md-6 d-flex gap-2">
                <button type="submit" name="action" value="view" class="btn btn-primary">
                    üîç L·ªçc
                </button>
                
                <a href="{{ url_for('system_logs_page') }}" class="btn btn-outline-secondary">X√≥a l·ªçc</a>

                <div class="vr"></div> <button type="submit" name="action" value="export" class="btn btn-success">
                    üì• Xu·∫•t CSV
                </button>

                <button type="button" class="btn btn-danger ms-auto" onclick="submitClearLog()">
                    üóëÔ∏è X√≥a Log n√†y
                </button>
            </div>
        </form>
        
        <form id="clearLogForm" action="{{ url_for('clear_system_logs') }}" method="POST">
			<input type="hidden" name="start_date" id="hidden_start">
			<input type="hidden" name="end_date" id="hidden_end">
		</form>
    </div>

    <p class="text-muted">T·ªïng c·ªông: <strong>{{ total_records }}</strong> b·∫£n ghi.</p>

    <div class="table-responsive">
        <table class="table table-sm table-hover table-bordered" style="font-size: 0.9em;">
            <thead class="table-dark">
                <tr>
                    <th>Th·ªùi gian</th>
                    <th>Ng∆∞·ªùi d√πng</th>
                    <th>H√†nh ƒë·ªông</th>
                    <th>Module</th>
                    <th>Chi ti·∫øt</th>
                    <th>IP / Thi·∫øt b·ªã</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs_list %}
                <tr>
                    <td style="white-space: nowrap;">{{ log.created_at }}</td>
                    <td class="fw-bold">{{ log.full_name or 'H·ªá th·ªëng' }}</td>
                    <td>
                        <span class="badge {% if 'DELETE' in log.action_type %}bg-danger{% elif 'UPDATE' in log.action_type %}bg-warning text-dark{% else %}bg-success{% endif %}">
                            {{ log.action_type }}
                        </span>
                    </td>
                    <td>{{ log.target_module }}</td>
                    <td>{{ log.description }}</td>
                    <td class="small text-muted" title="{{ log.device_info }}">
                        {{ log.ip_address }}
                    </td>
                </tr>
                {% endfor %}
                {% if not logs_list %}
                <tr><td colspan="6" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% if total_pages > 1 %}
    <nav>
        <ul class="pagination justify-content-center">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('system_logs_page', page=current_page-1, start_date=start_date, end_date=end_date) }}">Tr∆∞·ªõc</a>
            </li>
            
            <li class="page-item disabled">
                <span class="page-link">Trang {{ current_page }} / {{ total_pages }}</span>
            </li>

            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('system_logs_page', page=current_page+1, start_date=start_date, end_date=end_date) }}">Sau</a>
            </li>
        </ul>
    </nav>
    {% endif %}

    <script>
        function submitClearLog() {			

			// 1. L·∫•y gi√° tr·ªã t·ª´ √¥ hi·ªÉn th·ªã (D√πng ID m·ªõi)
			const startInput = document.getElementById('filter_start');
			const endInput = document.getElementById('filter_end');

			// Ki·ªÉm tra xem c√≥ t√¨m th·∫•y th·∫ª input kh√¥ng
			if (!startInput || !endInput) {
				alert("L·ªói: Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p ng√†y th√°ng trong HTML. Vui l√≤ng ki·ªÉm tra l·∫°i ID.");
				return;
			}

			const startVal = startInput.value;
			const endVal = endInput.value;


			// 2. Ki·ªÉm tra d·ªØ li·ªáu
			if (!startVal || !endVal) {
				alert("Vui l√≤ng ch·ªçn kho·∫£ng 'T·ª´ ng√†y' v√† 'ƒê·∫øn ng√†y' tr√™n thanh c√¥ng c·ª• tr∆∞·ªõc khi b·∫•m X√≥a!");
				return;
			}

			// 3. X√°c nh·∫≠n
			if (confirm(`C·∫¢NH B√ÅO AN NINH!\n\nB·∫°n s·∫Øp X√ìA Vƒ®NH VI·ªÑN nh·∫≠t k√Ω t·ª´ ng√†y ${startVal} ƒë·∫øn ${endVal}.\n\nH√†nh ƒë·ªông n√†y s·∫Ω ƒë∆∞·ª£c h·ªá th·ªëng ghi l·∫°i.\nB·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?`)) {
				
				// 4. ƒê·ªï d·ªØ li·ªáu v√†o form ·∫©n (D√πng ID m·ªõi)
				document.getElementById('hidden_start').value = startVal;
				document.getElementById('hidden_end').value = endVal;
				
				// 5. G·ª≠i form
				document.getElementById('clearLogForm').submit();
			}
		}
    </script>
{% endblock %}