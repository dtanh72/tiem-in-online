{% extends 'UI/base.html' %}

{% block title %}QUẢN LÝ ĐƠN HÀNG{% endblock %}

{% block content %}

    <h1>Lịch sử Đơn hàng (Doanh thu & Công nợ)</h1>

    <form class="filter-form" method="GET" action="{{ url_for('orders_history_page') }}" class="card card-body bg-light mb-4">
        <div class="row">
			<div class="col-6"><label for="start_date" class="form-label">Từ ngày:</label></div>
			<div class="col-6"><label for="end_date" class="form-label">Đến ngày:</label></div>
		</div>
		<div class="row">
			<div class="col-6"><input type="date" id="start_date" name="start_date" value="{{ start_date or '' }}" class="form-control"></div>
			<div class="col-6"><input type="date" id="end_date" name="end_date" value="{{ end_date or '' }}" class="form-control"></div>
		</div>
		</br>	
		<div class="row">
			<div class="col-md-8">
				<button type="submit" class="btn btn-primary w-100">Lọc</button>
			</div>
			<div class="col-md-4">
				<a href="{{ url_for('orders_history_page', filter='all') }}" class="btn btn-danger w-100">Xóa lọc</a>
			</div>
		</div>
		
		
    </form>
	<div class="container mt-3">
		<div class="d-flex gap-4 align-items-center mb-3">
			<h2 class="total-revenue m-0">
				Doanh thu thực: {{ total_revenue|currency }} vnđ
			</h2>
			<h3 class="text-secondary m-0">
				(Đã hủy: {{ total_cancelled|currency }} vnđ)
			</h3>
		</div>
		
		<h2 class="total-due">
			Tổng công nợ (còn thiếu): {{ total_due|currency }} vnđ
		</h2>
	</div>

    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Mã ĐH</th>
                <th>Ngày đặt</th>
                <th>Khách hàng</th>
                <th>Tổng tiền</th>
                <th>Đã trả</th>
                <th>Còn thiếu (Công nợ)</th>
                <th>TT Thanh toán</th>
				<th>TT Giao hàng</th>
                <th>Chi tiết</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders_list %}
            <tr>
                <td>{{ order.order_id }}</td>
                <td>{{ order.order_date }}</td>
                <td>{{ order.customer_name }}</td>
                <td>{{ order.total_amount|currency }}</td>
                <td>{{ order.amount_paid|currency }}</td>
                <td style="color: red; font-weight: bold;">{{ order.amount_due|currency }}</td>
                <td>{{ order.payment_status }}</td>
				<td>{{ order.delivery_status }}</td>
                <td>
                    <a href="{{ url_for('order_detail_page', order_id=order.order_id) }}" class="btn btn-sm btn-warning">Xem</a>
					{% if order.status == 'processing' %}
						<form action="{{ url_for('cancel_order', order_id=order.order_id) }}" method="POST" style="display:inline;"
							  onsubmit="return confirm('CẢNH BÁO: Hủy đơn hàng sẽ HOÀN LẠI vật tư vào kho. Bạn có chắc chắn?');">
							<button type="submit" class="btn btn-sm btn-danger">Hủy</button>
						</form>
					{% endif %}
					{% if order.status == 'cancelled' %}
						<span class="badge bg-secondary">Đã hủy</span>
					{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

{% endblock %}