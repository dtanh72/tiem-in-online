{% extends 'UI/base.html' %}
{% block title %}T·∫°o B√°o gi√° M·ªõi{% endblock %}

{% block content %}
    <h1>T·∫°o B√°o gi√° M·ªõi</h1>

    <form action="{{ url_for('submit_quote') }}" method="POST">
        <div class="container">
            <div class="row mb-3 bg-light p-3 rounded shadow-sm">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Th√¥ng tin Kh√°ch h√†ng:</label>
                    <div class="input-group">
                        <select id="customer_id" name="customer_id" required class="form-select">
                            <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
                            {% for customer in customers_list %}
                                <option value="{{ customer.customer_id }}"
										data-phone="{{ customer.phone or '' }}"
										data-email="{{ customer.email or '' }}"
										data-address="{{ customer.address or '' }}"
										data-company="{{ customer.company_name or '' }}"
										data-tax="{{ customer.tax_id or '' }}">
									{{ customer.customer_name }}
								</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-success" type="button" 
                                data-bs-toggle="modal" data-bs-target="#quickAddCustomerModal">+</button>
                    </div>
					
					<div id="customer_info_box" class="alert alert-info mt-2 pt-2 pb-2 small" style="display: none;">
						<div>üìû <strong>SƒêT:</strong> <span id="info_phone">...</span></div>
						<div id="row_company">üè¢ <strong>C√¥ng ty:</strong> <span id="info_company">...</span></div>
						<div id="row_tax">üìù <strong>MST:</strong> <span id="info_tax">...</span></div>
						<div>üìç <strong>ƒê·ªãa ch·ªâ:</strong> <span id="info_address">...</span></div>
					</div>
                    
                    <div class="mt-2">
                        <label for="notes" class="form-label">Ghi ch√∫:</label>
                        <textarea id="notes" name="notes" rows="2" class="form-control" placeholder="Ghi ch√∫ cho kh√°ch..."></textarea>
                    </div>
                </div>

                <div class="col-md-6 text-end">
                    <div class="p-3 border rounded bg-white">
                        <div class="mb-2">
                            <label class="fw-bold">Thu·∫ø VAT (%):</label>
                            <input type="number" id="tax_rate" name="tax_rate" value="10" step="0.1" style="width: 70px;" class="text-center border rounded">
                        </div>
                        <p class="mb-1">T·ªïng tr∆∞·ªõc thu·∫ø: <span id="sub_total" class="fw-bold">0</span> vnƒë</p>
                        <p class="mb-1">Ti·ªÅn thu·∫ø: <span id="tax_amount">0</span> vnƒë</p>
                        
                        <div class="input-group input-group-sm mt-2">
						<input type="text" id="coupon_code_input" class="form-control" placeholder="Nh·∫≠p m√£ KM">
						<button class="btn btn-outline-secondary" type="button" id="applyCouponBtn">√Åp d·ª•ng</button>
						</div>
						<div id="coupon_message" class="small mt-1"></div>
						<div class="mt-2">
							<small class="text-muted fw-bold">M√£ ƒëang ch·∫°y:</small>
							<div class="d-flex flex-wrap gap-1 mt-1 justify-content-end">
								{% if active_coupons %}
									{% for coupon in active_coupons %}
										<span class="badge rounded-pill bg-info text-dark border pointer-cursor" 
											  style="cursor: pointer;"
											  onclick="selectCoupon('{{ coupon.code }}')"
											  title="ƒê∆°n t·ªëi thi·ªÉu: {{ coupon.min_order_value|currency }}">
											
											{{ coupon.code }} 
											(-{{ coupon.discount_value|currency }}{% if coupon.discount_type == 'percent' %}%{% endif %})
										</span>
									{% endfor %}
								{% else %}
									<small class="text-muted fst-italic">Kh√¥ng c√≥ CTKM n√†o.</small>
								{% endif %}
							</div>
						</div>

						<p class="text-success mt-2">Gi·∫£m gi√°: -<span id="discount_display">0</span> vnƒë</p>

						<input type="hidden" name="coupon_code" id="final_coupon_code">
						<input type="hidden" name="discount_amount" id="final_discount_amount" value="0">

						<hr>
                        <h3 class="text-danger">T·ªïng c·ªông: <span id="grand_total">0</span> vnƒë</h3>
                        <button type="submit" class="btn btn-primary btn-lg mt-2">L∆ØU B√ÅO GI√Å</button>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3>Chi ti·∫øt B√°o gi√°</h3>
                <button class="btn btn-sm btn-outline-success" type="button" 
                        data-bs-toggle="modal" data-bs-target="#quickAddServiceModal">
                    + Th√™m nhanh D·ªãch v·ª•
                </button>
            </div>
            
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 35%;">D·ªãch v·ª•</th>
                        <th style="width: 25%;">Chi ti·∫øt S·ªë l∆∞·ª£ng (Nh√¢n d·ªìn)</th>
                        <th style="width: 15%;">ƒê∆°n gi√° (vnƒë)</th>
                        <th style="width: 20%;">Th√†nh ti·ªÅn (vnƒë)</th>
                        <th style="width: 5%;">X√≥a</th>
                    </tr>
                </thead>
                <tbody id="order_items_body">
                    </tbody>
            </table>
            
            <button type="button" id="add_service_btn" class="btn btn-secondary">+ Th√™m D√≤ng</button>
        </div>
    </form>

    <table style="display: none;">
        <tr id="service_row_template">
            <td>
                <select name="service_id[]" class="service_select form-select" required>
                    <option value="">-- Ch·ªçn d·ªãch v·ª• --</option>
                    {% for service in services_list %}
                        <option value="{{ service.service_id }}" 
                                data-price="{{ service.base_price }}" 
                                data-u1="{{ service.unit }}"
                                data-u2="{{ service.unit_level2 or '' }}"
                                data-u3="{{ service.unit_level3 or '' }}">
                            {{ service.service_name }}
                        </option>
                    {% endfor %}
                </select>
            </td>

            <td>
			
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control qty-input qty-l1" value="1" min="1" placeholder="1">
                    <span class="input-group-text u1-label">...</span>
                </div>
                
                <div class="input-group input-group-sm qty-wrapper-l2 mt-1" style="display:none;">
                    <span class="input-group-text">x</span>
                    <input type="number" class="form-control qty-input qty-l2" value="1" min="1">
                    <span class="input-group-text u2-label">...</span>
                </div>

                <div class="input-group input-group-sm qty-wrapper-l3 mt-1" style="display:none;">
                    <span class="input-group-text">x</span>
                    <input type="number" class="form-control qty-input qty-l3" value="1" min="1">
                    <span class="input-group-text u3-label">...</span>
                </div>
                
                <input type="hidden" name="quantity[]" class="final-qty" value="1">
                <div class="text-muted small text-end mt-1">T·ªïng: <span class="total-qty-display fw-bold">1</span> <span class="base-unit-display"></span></div>
            </td>

            <td>
                <input type="number" name="unit_price[]" class="price_input form-control" required>
            </td>

            <td>
                <input type="text" class="line_total_display form-control" value="0" readonly style="background: #eee; font-weight: bold;">
            </td>

            <td>
                <button type="button" class="delete-row-btn btn btn-danger btn-sm" onclick="deleteRow(this)">X</button>
            </td>
        </tr>
    </table>

    <div class="modal fade" id="quickAddCustomerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Th√™m nhanh Kh√°ch h√†ng</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="quickAddCustomerForm"><div class="mb-3"><label class="form-label">T√™n Kh√°ch h√†ng:</label><input type="text" id="quick_customer_name" class="form-control" required></div><div class="mb-3"><label class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label><input type="text" id="quick_customer_phone" class="form-control" required></div></form></div><div class="modal-footer"><button type="button" id="saveQuickAddCustomer" class="btn btn-primary">L∆∞u</button></div></div></div></div>

    <div class="modal fade" id="quickAddServiceModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Th√™m nhanh D·ªãch v·ª•</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="quickAddServiceForm">
						<div class="mb-3">
							<label class="form-label">T√™n D·ªãch v·ª•:</label>
							<input type="text" id="qs_name" class="form-control" required>
						</div>
						<div class="mb-3">
							<label class="form-label">ƒê∆°n gi√° (vnƒë):</label>
							<input type="number" id="qs_price" class="form-control" value="0">
						</div>
						
						<div class="row">
							<div class="col-md-4 mb-3">
								<label class="form-label small">ƒêV T·∫ßng 1 (C∆° s·ªü):</label>
								<input type="text" id="qs_unit" class="form-control" required placeholder="T·ªù">
							</div>
							<div class="col-md-4 mb-3">
								<label class="form-label small">ƒêV T·∫ßng 2 (x):</label>
								<input type="text" id="qs_unit2" class="form-control" placeholder="Cu·ªën">
							</div>
							<div class="col-md-4 mb-3">
								<label class="form-label small">ƒêV T·∫ßng 3 (x):</label>
								<input type="text" id="qs_unit3" class="form-control" placeholder="B·ªô">
							</div>
						</div>
						</form>
				</div>
				<div class="modal-footer">
					<button type="button" id="saveQuickService" class="btn btn-primary">L∆∞u</button>
				</div>
			</div>
		</div>
	</div>

    <script>
		let currentDiscount = 0;
	
        document.addEventListener('DOMContentLoaded', function() {
		
			// 1. L·∫Øng nghe s·ª± ki·ªán ch·ªçn kh√°ch h√†ng
			const customerSelect = document.getElementById('customer_id');
			const infoBox = document.getElementById('customer_info_box');
			
			// C√°c th·∫ª span hi·ªÉn th·ªã
			const infoPhone = document.getElementById('info_phone');
			const infoCompany = document.getElementById('info_company');
			const infoTax = document.getElementById('info_tax');
			const infoAddress = document.getElementById('info_address');
			
			const rowCompany = document.getElementById('row_company');
			const rowTax = document.getElementById('row_tax');

			customerSelect.addEventListener('change', function() {
				const opt = this.options[this.selectedIndex];
				
				if (this.value) {
					// L·∫•y d·ªØ li·ªáu t·ª´ data attributes
					const phone = opt.getAttribute('data-phone');
					const email = opt.getAttribute('data-email'); // C√≥ th·ªÉ hi·ªÉn th·ªã n·∫øu mu·ªën
					const address = opt.getAttribute('data-address');
					const company = opt.getAttribute('data-company');
					const tax = opt.getAttribute('data-tax');

					// ƒêi·ªÅn d·ªØ li·ªáu
					infoPhone.textContent = phone || '---';
					infoAddress.textContent = address || '---';
					infoCompany.textContent = company;
					infoTax.textContent = tax;

					// ·∫®n/Hi·ªán d√≤ng C√¥ng ty & MST n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu cho g·ªçn
					rowCompany.style.display = company ? 'block' : 'none';
					rowTax.style.display = tax ? 'block' : 'none';

					// Hi·ªán khung
					infoBox.style.display = 'block';
				} else {
					// ·∫®n khung n·∫øu ch∆∞a ch·ªçn
					infoBox.style.display = 'none';
				}
			});
		
            const addBtn = document.getElementById('add_service_btn');
            const tableBody = document.getElementById('order_items_body');
            const templateRow = document.getElementById('service_row_template');
            const taxRateInput = document.getElementById('tax_rate');
            
            // 1. H√ÄM T·∫†O D√íNG M·ªöI
            function addNewServiceRow() {
                const newRow = templateRow.cloneNode(true);
                newRow.id = '';
                tableBody.appendChild(newRow);
                attachRowListeners(newRow);
            }
            
            // 2. G·∫ÆN S·ª∞ KI·ªÜN & LOGIC ƒêA T·∫¶NG (FIXED)
            function attachRowListeners(row) {
                const serviceSelect = row.querySelector('.service_select');
                const priceInput = row.querySelector('.price_input');
                
                const qtyL1 = row.querySelector('.qty-l1');
                const qtyL2 = row.querySelector('.qty-l2');
                const qtyL3 = row.querySelector('.qty-l3');
                const wrapL2 = row.querySelector('.qty-wrapper-l2');
                const wrapL3 = row.querySelector('.qty-wrapper-l3');
                
                const lblU1 = row.querySelector('.u1-label');
                const lblU2 = row.querySelector('.u2-label');
                const lblU3 = row.querySelector('.u3-label');
                
                const finalQtyInput = row.querySelector('.final-qty');
                const totalQtyDisplay = row.querySelector('.total-qty-display');
                const baseUnitDisplay = row.querySelector('.base-unit-display');

                function updateRowQuantity() {
                    const v1 = parseFloat(qtyL1.value) || 0;
                    // N·∫øu wrap ·∫©n th√¨ coi nh∆∞ nh√¢n 1, n·∫øu hi·ªán th√¨ l·∫•y gi√° tr·ªã
                    const v2 = (wrapL2.style.display !== 'none') ? (parseFloat(qtyL2.value) || 1) : 1;
                    const v3 = (wrapL3.style.display !== 'none') ? (parseFloat(qtyL3.value) || 1) : 1;
                    
                    const total = v1 * v2 * v3;
                    finalQtyInput.value = total;
                    totalQtyDisplay.textContent = total.toLocaleString('vi-VN');
                    updateCalculations();
                }

                serviceSelect.addEventListener('change', function() {
                    const opt = this.options[this.selectedIndex];
                    const u1 = opt.getAttribute('data-u1') || '';
                    const u2 = opt.getAttribute('data-u2') || '';
                    const u3 = opt.getAttribute('data-u3') || '';
                    const price = opt.getAttribute('data-price');

                    if(price) priceInput.value = parseFloat(price).toFixed(0);
                    
                    lblU1.textContent = u1;
                    baseUnitDisplay.textContent = u1;

                    // Logic hi·ªÉn th·ªã T·∫ßng 2
                    if (u2 && u2.trim() !== '') { 
                        wrapL2.style.display = 'flex'; 
                        lblU2.textContent = u2; 
                    } else { 
                        wrapL2.style.display = 'none'; 
                        qtyL2.value = 1; 
                    }

                    // Logic hi·ªÉn th·ªã T·∫ßng 3
                    if (u3 && u3.trim() !== '') { 
                        wrapL3.style.display = 'flex'; 
                        lblU3.textContent = u3; 
                    } else { 
                        wrapL3.style.display = 'none'; 
                        qtyL3.value = 1; 
                    }
                    
                    updateRowQuantity();
                });

                qtyL1.addEventListener('input', updateRowQuantity);
                qtyL2.addEventListener('input', updateRowQuantity);
                qtyL3.addEventListener('input', updateRowQuantity);
                priceInput.addEventListener('input', updateCalculations);
            }
            
            // 3. T√çNH T·ªîNG TI·ªÄN (BAO G·ªíM DISCOUNT)
            function updateCalculations() {
                let subTotal = 0;
                const allRows = tableBody.querySelectorAll('tr');
                allRows.forEach(function(row) {
                    const quantity = parseFloat(row.querySelector('.final-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.price_input').value) || 0;
                    const lineTotal = quantity * price;
                    row.querySelector('.line_total_display').value = lineTotal.toLocaleString('vi-VN');
                    subTotal += lineTotal;
                });
                
                const taxRate = parseFloat(taxRateInput.value) || 0;
                const taxAmount = subTotal * (taxRate / 100);
                
                // T√≠nh gi·∫£m gi√°
                let totalWithTax = subTotal + taxAmount;
                let actualDiscount = currentDiscount;
                if(actualDiscount > totalWithTax) actualDiscount = totalWithTax;

                const grandTotal = totalWithTax - actualDiscount;
                
                document.getElementById('sub_total').textContent = subTotal.toLocaleString('vi-VN');
                document.getElementById('tax_amount').textContent = taxAmount.toLocaleString('vi-VN');
                
                document.getElementById('discount_display').textContent = actualDiscount.toLocaleString('vi-VN');
                document.getElementById('final_discount_amount').value = actualDiscount;

                document.getElementById('grand_total').textContent = grandTotal.toLocaleString('vi-VN');
            }
            
            window.deleteRow = function(btn) { btn.closest('tr').remove(); updateCalculations(); }
            window.selectCoupon = function(code) {
                document.getElementById('coupon_code_input').value = code;
                document.getElementById('applyCouponBtn').click();
            }
            
            addBtn.addEventListener('click', addNewServiceRow);
            taxRateInput.addEventListener('change', updateCalculations);
            addNewServiceRow(); // Th√™m d√≤ng ƒë·∫ßu ti√™n
			
			// 4. X·ª¨ L√ù N√öT √ÅP D·ª§NG M√É
            document.getElementById('applyCouponBtn').addEventListener('click', function() {
                const code = document.getElementById('coupon_code_input').value;
                const subTotalText = document.getElementById('sub_total').textContent.replace(/\./g, '').replace(/,/g, '');
                const currentTotal = parseFloat(subTotalText) || 0;

                if (!code) return;

                const formData = new FormData();
                formData.append('code', code);
                formData.append('order_total', currentTotal);

                fetch("{{ url_for('check_coupon') }}", { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    const msgDiv = document.getElementById('coupon_message');
                    if (data.valid) {
                        msgDiv.className = 'small mt-1 text-success';
                        msgDiv.textContent = data.message;
                        currentDiscount = data.discount_amount;
                        document.getElementById('final_coupon_code').value = data.code;
                        updateCalculations();
                    } else {
                        msgDiv.className = 'small mt-1 text-danger';
                        msgDiv.textContent = data.message;
                        currentDiscount = 0;
                        document.getElementById('final_coupon_code').value = '';
                        updateCalculations();
                    }
                });
            });

            // 5. AJAX TH√äM KH√ÅCH
            document.getElementById('saveQuickAddCustomer').addEventListener('click', function() {
                const name = document.getElementById('quick_customer_name').value;
                const phone = document.getElementById('quick_customer_phone').value;
                if (!name) return;
                const formData = new FormData(); formData.append('customer_name', name); formData.append('phone', phone);
                fetch("{{ url_for('ajax_add_customer') }}", { method: 'POST', body: formData }).then(r=>r.json()).then(d=>{
                    if(d.success){
                        const opt = document.createElement('option'); opt.value=d.new_id; opt.text=d.new_name; opt.selected=true;
                        document.getElementById('customer_id').appendChild(opt);
                        bootstrap.Modal.getInstance(document.getElementById('quickAddCustomerModal')).hide();
                    } else alert(d.error);
                });
            });

            // 6. AJAX TH√äM D·ªäCH V·ª§
            document.getElementById('saveQuickService').addEventListener('click', function() {
				// 1. L·∫•y d·ªØ li·ªáu
				const name = document.getElementById('qs_name').value;
				const price = document.getElementById('qs_price').value;
				const u1 = document.getElementById('qs_unit').value;
				const u2 = document.getElementById('qs_unit2').value; // M·ªõi
				const u3 = document.getElementById('qs_unit3').value; // M·ªõi
				
				if(!name || !u1) return alert("Vui l√≤ng nh·∫≠p T√™n v√† ƒê∆°n v·ªã c∆° s·ªü!");

				const formData = new FormData();
				formData.append('service_name', name);
				formData.append('base_price', price);
				formData.append('unit', u1);
				formData.append('unit_level2', u2); // G·ª≠i th√™m
				formData.append('unit_level3', u3); // G·ª≠i th√™m

				// 2. G·ª≠i AJAX
				fetch("{{ url_for('ajax_add_service') }}", {
					method: 'POST',
					body: formData
				})
				.then(res => res.json())
				.then(data => {
					if(data.success) {
						// 3. T·∫°o option m·ªõi v·ªõi ƒë·∫ßy ƒë·ªß data attributes
						const opt = document.createElement('option');
						opt.value = data.new_id;
						opt.text = data.new_name;
						opt.selected = true;
						
						// QUAN TR·ªåNG: C·∫≠p nh·∫≠t ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë∆°n v·ªã v√†o th·∫ª option
						opt.setAttribute('data-price', data.new_price);
						opt.setAttribute('data-u1', data.new_u1);
						opt.setAttribute('data-u2', data.new_u2);
						opt.setAttribute('data-u3', data.new_u3);
						
						// 4. C·∫≠p nh·∫≠t v√†o t·∫•t c·∫£ c√°c dropdown ƒëang c√≥
						// (N·∫øu ·ªü trang ƒë·ªãnh m·ª©c th√¨ ID l√† 'service_id', n·∫øu ·ªü trang ƒë∆°n h√†ng th√¨ class l√† '.service_select')
						const singleSelect = document.getElementById('service_id');
						if (singleSelect) {
							singleSelect.appendChild(opt);
							// K√≠ch ho·∫°t s·ª± ki·ªán change ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán ngay
							singleSelect.dispatchEvent(new Event('change'));
						}
						
						const listSelects = document.querySelectorAll('.service_select');
						if (listSelects.length > 0) {
							listSelects.forEach(s => s.appendChild(opt.cloneNode(true)));
						}

						// 5. ƒê√≥ng modal & Reset
						bootstrap.Modal.getInstance(document.getElementById('quickAddServiceModal')).hide();
						document.getElementById('quickAddServiceForm').reset();
						
					} else {
						alert('L·ªói: ' + data.error);
					}
				});
			});
			
			// === 7. H√ÄM CH·ªåN M√É T·ª™ DANH S√ÅCH G·ª¢I √ù ===
			function selectCoupon(code) {
				// 1. ƒêi·ªÅn m√£ v√†o √¥ input
				document.getElementById('coupon_code_input').value = code;
				
				// 2. T·ª± ƒë·ªông k√≠ch ho·∫°t s·ª± ki·ªán click c·ªßa n√∫t √Åp d·ª•ng
				document.getElementById('applyCouponBtn').click();
			}
        });
    </script>
{% endblock %}