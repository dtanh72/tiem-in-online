{% extends 'UI/base.html' %}

{% block title %}QUẢN LÝ BÁO GIÁ{% endblock %}

{% block content %}

    <h1>Chi tiết Báo Giá #{{ quote_info.quote_id }}</h1>
    <a href="{{ url_for('quotes_history_page') }}" class="btn btn-sm btn-warning">&larr; Quay lại Lịch sử</a>

    <div class="mb-3">
        <div class="mb-3">
            <table class="table table-striped table-hover">
				<thead>
					<tr><th><h2>Thông tin chung</h2></th></tr>
					<tr>
						<th><strong>Khách hàng:</strong></th>
						<td>{{ quote_info.customer_name }}</td>
					</tr>
					<tr>
						<th><strong>Ngày tạo:</strong></th>
						<td>{{ quote_info.created_date }}</td>
					</tr>
					<tr>
						<th><strong>Ghi chú:</strong></th>
						<td>{{ quote_info.notes }}</td>
					</tr>					
				</thead>
			</table>
			<div class="col w-100 mb-3">
				<p><strong>Tổng trước thuế:</strong> {{ quote_info.subtotal|currency }} vnđ</p>
				<p><strong>Thuế ({{ quote_info.tax_rate }}%):</strong> {{ quote_info.tax_amount|currency }} vnđ</p>
				<p style="font-size: 1.2em; font-weight: bold;">
					<strong>Tổng tiền báo giá: {{ quote_info.total_amount|currency }} vnđ</strong>
				</p>
			</div>
        </div>
		
        {% if quote_info.status != 'accepted' %}
        <div class="mb-3">
            <form action="{{ url_for('update_quote_status', quote_id=quote_info.quote_id) }}" method="POST"
					class="card card-body bg-light mb-4">
					
				<h2>Trạng thái Báo giá</h2>
                <p>Trạng thái hiện tại: <strong>{{ quote_info.status }}</strong></p>
                <select name="quote_status" style="padding: 5px;">
                    <option value="pending" {% if quote_info.status == 'pending' %}selected{% endif %}>Chờ xử lý (Pending)</option>
                    <option value="accepted" {% if quote_info.status == 'accepted' %}selected{% endif %}>Chấp nhận (Accepted)</option>
                    <option value="rejected" {% if quote_info.status == 'rejected' %}selected{% endif %}>Từ chối (Rejected)</option>
                </select>
                <button type="submit" 
						style="margin-top: 15px; padding: 10px; background: #007bff; color: white; border: none;"
						onclick="return confirm('Bạn có chắc chắn muốn cập nhật trạng thái báo giá?');"
						class="btn btn-primary">
						Cập nhật Trạng thái
				</button>
            </form>
        </div>
		{% endif %}
		
		{% if quote_info.status == 'accepted' %}
        <div class="mb-3">
            <form action="{{ url_for('convert_quote_to_order', quote_id=quote_info.quote_id) }}" method="POST"
					class="card card-body bg-light mb-4">
				<h2>Chuyển đổi</h2>
				<p>Chuyển báo giá này thành một Đơn hàng mới. <br>
				   <strong>(Lưu ý: Hành động này sẽ TRỪ KHO vật tư!)</strong></p>
				
                <button type="submit" 
                        style="padding: 10px 15px; background: #5cb85c; color: white; border: none; font-size: 1.1em;"
                        onclick="return confirm('Bạn có chắc chắn muốn chuyển báo giá này thành Đơn hàng? Kho sẽ bị trừ ngay lập tức.');"
						class="btn btn-primary">
                    &rarr; Chuyển thành Đơn hàng
                </button>
            </form>
        </div>
        {% endif %}
		
    </div>

    <h2>Các dịch vụ trong báo giá</h2>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Tên Dịch vụ</th>
                <th>Số lượng</th>
                <th>Đơn vị</th>
                <th>Đơn giá</th>
                <th>Thành tiền</th>
            </tr>
        </thead>
        <tbody>
            {% for item in quote_items %}
            <tr>
                <td>{{ item.service_name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.unit }}</td>
                <td>{{ item.unit_price|currency }}</td>
                <td>{{ item.line_total|currency }}</td>
            </tr>
            {% endfor %}
            <tr >
                <td colspan="4" style="text-align: right;">TỔNG CỘNG</td>
                <td>{{ quote_info.total_amount|currency }}</td>
            </tr>
        </tbody>
    </table>

{% endblock %}